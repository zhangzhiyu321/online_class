<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.zzy.backend.mapper.student.payment.PaymentMapper">

    <!-- 支付结果映射 -->
    <resultMap id="PaymentResultMap" type="com.zzy.backend.entity.student.Payment">
        <id property="id" column="id"/>
        <result property="paymentNo" column="payment_no"/>
        <result property="appointmentId" column="appointment_id"/>
        <result property="studentId" column="student_id"/>
        <result property="teacherId" column="teacher_id"/>
        <result property="amount" column="amount"/>
        <result property="paymentMethod" column="payment_method"/>
        <result property="transferImage" column="transfer_image"/>
        <result property="transferTime" column="transfer_time"/>
        <result property="transferAccount" column="transfer_account"/>
        <result property="transferAmount" column="transfer_amount"/>
        <result property="status" column="status"/>
        <result property="rejectReason" column="reject_reason"/>
        <result property="confirmedAt" column="confirmed_at"/>
        <result property="confirmedBy" column="confirmed_by"/>
        <result property="extra" column="extra"/>
        <result property="version" column="version"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
        <result property="deletedAt" column="deleted_at"/>
    </resultMap>

    <!-- 插入支付记录 -->
    <insert id="insert" parameterType="com.zzy.backend.entity.student.Payment" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO payments (
            payment_no,
            appointment_id,
            student_id,
            teacher_id,
            amount,
            payment_method,
            transfer_image,
            transfer_time,
            transfer_account,
            status,
            reject_reason,
            confirmed_at,
            confirmed_by,
            extra,
            version,
            created_at,
            updated_at
        ) VALUES (
            #{paymentNo},
            #{appointmentId},
            #{studentId},
            #{teacherId},
            #{amount},
            #{paymentMethod},
            #{transferImage},
            #{transferTime},
            #{transferAccount},
            #{status},
            #{rejectReason},
            #{confirmedAt},
            #{confirmedBy},
            #{extra},
            #{version},
            #{createdAt},
            #{updatedAt}
        )
    </insert>

    <!-- 根据支付单号查询支付记录 -->
    <select id="selectByPaymentNo" resultMap="PaymentResultMap">
        SELECT *
        FROM payments
        WHERE payment_no = #{paymentNo}
          AND deleted_at IS NULL
    </select>

    <!-- 根据ID查询支付记录 -->
    <select id="selectById" resultMap="PaymentResultMap">
        SELECT *
        FROM payments
        WHERE id = #{id}
          AND deleted_at IS NULL
    </select>

    <!-- 根据预约ID查询支付记录 -->
    <select id="selectByAppointmentId" resultMap="PaymentResultMap">
        SELECT *
        FROM payments
        WHERE appointment_id = #{appointmentId}
          AND deleted_at IS NULL
        ORDER BY created_at DESC
        LIMIT 1
    </select>

    <!-- 支付列表项结果映射 -->
    <resultMap id="PaymentListItemResultMap" type="com.zzy.backend.dto.response.student.payment.PaymentListItemResponse">
        <id property="id" column="id"/>
        <result property="paymentNo" column="payment_no"/>
        <result property="appointmentId" column="appointment_id"/>
        <result property="teacherId" column="teacher_id"/>
        <result property="teacherName" column="teacher_name"/>
        <result property="amount" column="amount"/>
        <result property="status" column="status"/>
        <result property="appointmentDate" column="appointment_date"/>
        <result property="createdAt" column="created_at"/>
    </resultMap>

    <!-- 支付详情结果映射 -->
    <resultMap id="PaymentDetailResultMap" type="com.zzy.backend.dto.response.student.payment.PaymentDetailResponse">
        <id property="id" column="id"/>
        <result property="paymentNo" column="payment_no"/>
        <result property="appointmentId" column="appointment_id"/>
        <result property="teacherId" column="teacher_id"/>
        <result property="teacherName" column="teacher_name"/>
        <result property="amount" column="amount"/>
        <result property="paymentMethod" column="payment_method"/>
        <result property="bankName" column="bank_name"/>
        <result property="bankAccount" column="bank_account"/>
        <result property="accountHolder" column="account_holder"/>
        <result property="transferImage" column="transfer_image"/>
        <result property="transferAmount" column="transfer_amount"/>
        <result property="transferTime" column="transfer_time"/>
        <result property="transferAccount" column="transfer_account"/>
        <result property="alipayQrCode" column="alipay_qr_code"/>
        <result property="wechatQrCode" column="wechat_qr_code"/>
        <result property="status" column="status"/>
        <result property="rejectReason" column="reject_reason"/>
        <result property="appointmentDate" column="appointment_date"/>
        <result property="createdAt" column="created_at"/>
    </resultMap>

    <!-- 查询支付列表 -->
    <select id="selectPaymentList" resultMap="PaymentListItemResultMap">
        SELECT
            p.id,
            p.payment_no,
            p.appointment_id,
            p.teacher_id,
            COALESCE(u.nickname, u.username, tp.real_name, '未知教师') AS teacher_name,
            p.amount,
            p.status,
            a.appointment_date,
            p.created_at
        FROM payments p
        INNER JOIN appointments a ON p.appointment_id = a.id AND a.deleted_at IS NULL
        INNER JOIN users u ON p.teacher_id = u.id AND u.deleted_at IS NULL
        LEFT JOIN teacher_profiles tp ON p.teacher_id = tp.user_id AND tp.deleted_at IS NULL
        WHERE p.student_id = #{studentId}
          AND p.deleted_at IS NULL
        <if test="status != null">
            AND p.status = #{status}
        </if>
        <if test="keyword != null and keyword != ''">
            AND (
                COALESCE(u.nickname, u.username, tp.real_name, '') LIKE CONCAT('%', #{keyword}, '%')
                OR p.payment_no LIKE CONCAT('%', #{keyword}, '%')
            )
        </if>
        ORDER BY p.created_at DESC
        LIMIT #{offset}, #{pageSize}
    </select>

    <!-- 统计支付总数 -->
    <select id="countPaymentList" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM payments p
        INNER JOIN appointments a ON p.appointment_id = a.id AND a.deleted_at IS NULL
        INNER JOIN users u ON p.teacher_id = u.id AND u.deleted_at IS NULL
        LEFT JOIN teacher_profiles tp ON p.teacher_id = tp.user_id AND tp.deleted_at IS NULL
        WHERE p.student_id = #{studentId}
          AND p.deleted_at IS NULL
        <if test="status != null">
            AND p.status = #{status}
        </if>
        <if test="keyword != null and keyword != ''">
            AND (
                COALESCE(u.nickname, u.username, tp.real_name, '') LIKE CONCAT('%', #{keyword}, '%')
                OR p.payment_no LIKE CONCAT('%', #{keyword}, '%')
            )
        </if>
    </select>

    <!-- 查询支付详情 -->
    <select id="selectPaymentDetail" resultMap="PaymentDetailResultMap">
        SELECT
            p.id,
            p.payment_no,
            p.appointment_id,
            p.teacher_id,
            COALESCE(u.nickname, u.username, tp.real_name, '未知教师') AS teacher_name,
            p.amount,
            p.payment_method,
            tp.bank_name,
            tp.bank_account,
            tp.account_holder,
            p.transfer_image,
            p.amount AS transfer_amount,
            p.transfer_time,
            p.transfer_account,
            CASE 
                WHEN p.payment_method = 2 THEN CONCAT('https://example.com/qrcode/alipay/', p.payment_no)
                ELSE NULL 
            END AS alipay_qr_code,
            CASE 
                WHEN p.payment_method = 3 THEN CONCAT('https://example.com/qrcode/wechat/', p.payment_no)
                ELSE NULL 
            END AS wechat_qr_code,
            p.status,
            p.reject_reason,
            a.appointment_date,
            p.created_at
        FROM payments p
        INNER JOIN appointments a ON p.appointment_id = a.id AND a.deleted_at IS NULL
        INNER JOIN users u ON p.teacher_id = u.id AND u.deleted_at IS NULL
        LEFT JOIN teacher_profiles tp ON p.teacher_id = tp.user_id AND tp.deleted_at IS NULL
        WHERE p.id = #{id}
          AND p.student_id = #{studentId}
          AND p.deleted_at IS NULL
    </select>

    <!-- 更新支付凭证信息 -->
    <update id="updatePaymentProof">
        UPDATE payments
        SET transfer_image = #{transferImage},
            transfer_time = #{transferTime},
            transfer_account = #{transferAccount},
            status = #{status},
            updated_at = NOW()
        WHERE id = #{id}
          AND deleted_at IS NULL
    </update>

    <!-- 更新支付方式 -->
    <update id="updatePaymentMethod">
        UPDATE payments
        SET payment_method = #{paymentMethod},
            updated_at = NOW()
        WHERE id = #{id}
          AND status = 1
          AND deleted_at IS NULL
    </update>

</mapper>

